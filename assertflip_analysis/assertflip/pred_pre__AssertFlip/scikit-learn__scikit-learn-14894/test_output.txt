+ source /opt/miniconda3/bin/activate
++ _CONDA_ROOT=/opt/miniconda3
++ . /opt/miniconda3/etc/profile.d/conda.sh
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ '[' -z '' ']'
+++ export CONDA_SHLVL=0
+++ CONDA_SHLVL=0
+++ '[' -n '' ']'
+++++ dirname /opt/miniconda3/bin/conda
++++ dirname /opt/miniconda3/bin
+++ PATH=/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export PATH
+++ '[' -z '' ']'
+++ PS1=
++ conda activate
++ local cmd=activate
++ case "$cmd" in
++ __conda_activate activate
++ '[' -n '' ']'
++ local ask_conda
+++ PS1=
+++ __conda_exe shell.posix activate
+++ /opt/miniconda3/bin/conda shell.posix activate
++ ask_conda='PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''1'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ eval 'PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''1'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+++ PS1='(base) '
+++ export PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export CONDA_PREFIX=/opt/miniconda3
+++ CONDA_PREFIX=/opt/miniconda3
+++ export CONDA_SHLVL=1
+++ CONDA_SHLVL=1
+++ export CONDA_DEFAULT_ENV=base
+++ CONDA_DEFAULT_ENV=base
+++ export 'CONDA_PROMPT_MODIFIER=(base) '
+++ CONDA_PROMPT_MODIFIER='(base) '
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ __conda_hashr
++ '[' -n '' ']'
++ '[' -n '' ']'
++ hash -r
+ conda activate testbed
+ local cmd=activate
+ case "$cmd" in
+ __conda_activate activate testbed
+ '[' -n '' ']'
+ local ask_conda
++ PS1='(base) '
++ __conda_exe shell.posix activate testbed
++ /opt/miniconda3/bin/conda shell.posix activate testbed
+ ask_conda='PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''2'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_1='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+ eval 'PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''2'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_1='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ PS1='(testbed) '
++ export PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ export CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ export CONDA_SHLVL=2
++ CONDA_SHLVL=2
++ export CONDA_DEFAULT_ENV=testbed
++ CONDA_DEFAULT_ENV=testbed
++ export 'CONDA_PROMPT_MODIFIER=(testbed) '
++ CONDA_PROMPT_MODIFIER='(testbed) '
++ export CONDA_PREFIX_1=/opt/miniconda3
++ CONDA_PREFIX_1=/opt/miniconda3
++ export CONDA_EXE=/opt/miniconda3/bin/conda
++ CONDA_EXE=/opt/miniconda3/bin/conda
++ export _CE_M=
++ _CE_M=
++ export _CE_CONDA=
++ _CE_CONDA=
++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+ __conda_hashr
+ '[' -n '' ']'
+ '[' -n '' ']'
+ hash -r
+ cd /testbed
+ git diff HEAD fdbaa58acbead5a254f2e6d597dc1ab3b947f4c6
+ git config --global --add safe.directory /testbed
+ cd /testbed
+ git status
On branch main
nothing to commit, working tree clean
+ git show
commit fdbaa58acbead5a254f2e6d597dc1ab3b947f4c6
Author: Roman Yurchak <rth.yurchak@pm.me>
Date:   Mon Oct 7 17:35:01 2019 +0200

    TST Skip some doctests if pillow not installed (#15131)

diff --git a/build_tools/azure/install.sh b/build_tools/azure/install.sh
index 4c0622396a..b3a680d0a5 100755
--- a/build_tools/azure/install.sh
+++ b/build_tools/azure/install.sh
@@ -93,7 +93,7 @@ elif [[ "$DISTRIB" == "conda-pip-latest" ]]; then
     make_conda "python=$PYTHON_VERSION"
     python -m pip install numpy scipy joblib cython
     python -m pip install pytest==$PYTEST_VERSION pytest-cov pytest-xdist
-    python -m pip install pandas matplotlib pyamg pillow
+    python -m pip install pandas matplotlib pyamg
 fi
 
 if [[ "$COVERAGE" == "true" ]]; then
diff --git a/conftest.py b/conftest.py
index 73326d6d2e..0c0e21b69b 100644
--- a/conftest.py
+++ b/conftest.py
@@ -13,6 +13,7 @@ from _pytest.doctest import DoctestItem
 
 from sklearn import set_config
 from sklearn.utils import _IS_32BIT
+from sklearn.externals import _pilutil
 
 PYTEST_MIN_VERSION = '3.3.0'
 
@@ -68,6 +69,13 @@ def pytest_collection_modifyitems(config, items):
         for item in items:
             if isinstance(item, DoctestItem):
                 item.add_marker(skip_marker)
+    elif not _pilutil.pillow_installed:
+        skip_marker = pytest.mark.skip(reason="pillow (or PIL) not installed!")
+        for item in items:
+            if item.name in [
+                    "sklearn.feature_extraction.image.PatchExtractor",
+                    "sklearn.feature_extraction.image.extract_patches_2d"]:
+                item.add_marker(skip_marker)
 
 
 def pytest_configure(config):
+ git diff fdbaa58acbead5a254f2e6d597dc1ab3b947f4c6
+ source /opt/miniconda3/bin/activate
++ _CONDA_ROOT=/opt/miniconda3
++ . /opt/miniconda3/etc/profile.d/conda.sh
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ '[' -z x ']'
++ conda activate
++ local cmd=activate
++ case "$cmd" in
++ __conda_activate activate
++ '[' -n '' ']'
++ local ask_conda
+++ PS1='(testbed) '
+++ __conda_exe shell.posix activate
+++ /opt/miniconda3/bin/conda shell.posix activate
++ ask_conda='PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''3'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_PREFIX_2='\''/opt/miniconda3/envs/testbed'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ eval 'PS1='\''(base) '\''
export PATH='\''/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3'\''
export CONDA_SHLVL='\''3'\''
export CONDA_DEFAULT_ENV='\''base'\''
export CONDA_PROMPT_MODIFIER='\''(base) '\''
export CONDA_PREFIX_2='\''/opt/miniconda3/envs/testbed'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+++ PS1='(base) '
+++ export PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ PATH=/opt/miniconda3/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
+++ export CONDA_PREFIX=/opt/miniconda3
+++ CONDA_PREFIX=/opt/miniconda3
+++ export CONDA_SHLVL=3
+++ CONDA_SHLVL=3
+++ export CONDA_DEFAULT_ENV=base
+++ CONDA_DEFAULT_ENV=base
+++ export 'CONDA_PROMPT_MODIFIER=(base) '
+++ CONDA_PROMPT_MODIFIER='(base) '
+++ export CONDA_PREFIX_2=/opt/miniconda3/envs/testbed
+++ CONDA_PREFIX_2=/opt/miniconda3/envs/testbed
+++ export CONDA_EXE=/opt/miniconda3/bin/conda
+++ CONDA_EXE=/opt/miniconda3/bin/conda
+++ export _CE_M=
+++ _CE_M=
+++ export _CE_CONDA=
+++ _CE_CONDA=
+++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ __conda_hashr
++ '[' -n '' ']'
++ '[' -n '' ']'
++ hash -r
+ conda activate testbed
+ local cmd=activate
+ case "$cmd" in
+ __conda_activate activate testbed
+ '[' -n '' ']'
+ local ask_conda
++ PS1='(base) '
++ __conda_exe shell.posix activate testbed
++ /opt/miniconda3/bin/conda shell.posix activate testbed
+ ask_conda='PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''4'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_3='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
+ eval 'PS1='\''(testbed) '\''
export PATH='\''/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'\''
export CONDA_PREFIX='\''/opt/miniconda3/envs/testbed'\''
export CONDA_SHLVL='\''4'\''
export CONDA_DEFAULT_ENV='\''testbed'\''
export CONDA_PROMPT_MODIFIER='\''(testbed) '\''
export CONDA_PREFIX_3='\''/opt/miniconda3'\''
export CONDA_EXE='\''/opt/miniconda3/bin/conda'\''
export _CE_M='\'''\''
export _CE_CONDA='\'''\''
export CONDA_PYTHON_EXE='\''/opt/miniconda3/bin/python'\'''
++ PS1='(testbed) '
++ export PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ PATH=/opt/miniconda3/envs/testbed/bin:/opt/miniconda3/condabin:/opt/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
++ export CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ CONDA_PREFIX=/opt/miniconda3/envs/testbed
++ export CONDA_SHLVL=4
++ CONDA_SHLVL=4
++ export CONDA_DEFAULT_ENV=testbed
++ CONDA_DEFAULT_ENV=testbed
++ export 'CONDA_PROMPT_MODIFIER=(testbed) '
++ CONDA_PROMPT_MODIFIER='(testbed) '
++ export CONDA_PREFIX_3=/opt/miniconda3
++ CONDA_PREFIX_3=/opt/miniconda3
++ export CONDA_EXE=/opt/miniconda3/bin/conda
++ CONDA_EXE=/opt/miniconda3/bin/conda
++ export _CE_M=
++ _CE_M=
++ export _CE_CONDA=
++ _CE_CONDA=
++ export CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
++ CONDA_PYTHON_EXE=/opt/miniconda3/bin/python
+ __conda_hashr
+ '[' -n '' ']'
+ '[' -n '' ']'
+ hash -r
+ python -m pip install -v --no-use-pep517 --no-build-isolation -e .
Using pip 21.2.2 from /opt/miniconda3/envs/testbed/lib/python3.6/site-packages/pip (python 3.6)
Obtaining file:///testbed
    Running command python setup.py egg_info
    running egg_info
    creating /tmp/pip-pip-egg-info-1x_g6qwa/scikit_learn.egg-info
    writing /tmp/pip-pip-egg-info-1x_g6qwa/scikit_learn.egg-info/PKG-INFO
    writing dependency_links to /tmp/pip-pip-egg-info-1x_g6qwa/scikit_learn.egg-info/dependency_links.txt
    writing requirements to /tmp/pip-pip-egg-info-1x_g6qwa/scikit_learn.egg-info/requires.txt
    writing top-level names to /tmp/pip-pip-egg-info-1x_g6qwa/scikit_learn.egg-info/top_level.txt
    writing manifest file '/tmp/pip-pip-egg-info-1x_g6qwa/scikit_learn.egg-info/SOURCES.txt'
    reading manifest file '/tmp/pip-pip-egg-info-1x_g6qwa/scikit_learn.egg-info/SOURCES.txt'
    reading manifest template 'MANIFEST.in'
    adding license file 'COPYING'
    writing manifest file '/tmp/pip-pip-egg-info-1x_g6qwa/scikit_learn.egg-info/SOURCES.txt'
    Partial import of sklearn during the build process.
Requirement already satisfied: numpy>=1.11.0 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from scikit-learn==0.22.dev0) (1.19.2)
Requirement already satisfied: scipy>=0.17.0 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from scikit-learn==0.22.dev0) (1.5.2)
Requirement already satisfied: joblib>=0.11 in /opt/miniconda3/envs/testbed/lib/python3.6/site-packages (from scikit-learn==0.22.dev0) (1.1.1)
Installing collected packages: scikit-learn
  Attempting uninstall: scikit-learn
    Found existing installation: scikit-learn 0.22.dev0
    Uninstalling scikit-learn-0.22.dev0:
      Removing file or directory /opt/miniconda3/envs/testbed/lib/python3.6/site-packages/scikit-learn.egg-link
      Removing pth entries from /opt/miniconda3/envs/testbed/lib/python3.6/site-packages/easy-install.pth:
      Removing entry: /testbed
      Successfully uninstalled scikit-learn-0.22.dev0
  Running setup.py develop for scikit-learn
    Running command /opt/miniconda3/envs/testbed/bin/python -c 'import io, os, sys, setuptools, tokenize; sys.argv[0] = '"'"'/testbed/setup.py'"'"'; __file__='"'"'/testbed/setup.py'"'"';f = getattr(tokenize, '"'"'open'"'"', open)(__file__) if os.path.exists(__file__) else io.StringIO('"'"'from setuptools import setup; setup()'"'"');code = f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' develop --no-deps
    C compiler: gcc -pthread -B /opt/miniconda3/envs/testbed/compiler_compat -Wl,--sysroot=/ -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC

    compile options: '-c'
    extra options: '-fopenmp'
    gcc: test_openmp.c
    gcc -pthread -B /opt/miniconda3/envs/testbed/compiler_compat -Wl,--sysroot=/ objects/test_openmp.o -o test_openmp -fopenmp
    running develop
    running build_scripts
    running egg_info
    running build_src
    build_src
    building library "libsvm-skl" sources
    building extension "sklearn.__check_build._check_build" sources
    building extension "sklearn.preprocessing._csr_polynomial_expansion" sources
    building extension "sklearn.cluster._dbscan_inner" sources
    building extension "sklearn.cluster._hierarchical" sources
    building extension "sklearn.cluster._k_means_elkan" sources
    building extension "sklearn.cluster._k_means" sources
    building extension "sklearn.datasets._svmlight_format" sources
    building extension "sklearn.decomposition._online_lda" sources
    building extension "sklearn.decomposition.cdnmf_fast" sources
    building extension "sklearn.ensemble._gradient_boosting" sources
    building extension "sklearn.ensemble._hist_gradient_boosting._gradient_boosting" sources
    building extension "sklearn.ensemble._hist_gradient_boosting.histogram" sources
    building extension "sklearn.ensemble._hist_gradient_boosting.splitting" sources
    building extension "sklearn.ensemble._hist_gradient_boosting._binning" sources
    building extension "sklearn.ensemble._hist_gradient_boosting._predictor" sources
    building extension "sklearn.ensemble._hist_gradient_boosting._loss" sources
    building extension "sklearn.ensemble._hist_gradient_boosting.common" sources
    building extension "sklearn.ensemble._hist_gradient_boosting.utils" sources
    building extension "sklearn.feature_extraction._hashing" sources
    building extension "sklearn.manifold._utils" sources
    building extension "sklearn.manifold._barnes_hut_tsne" sources
    building extension "sklearn.metrics.cluster.expected_mutual_info_fast" sources
    building extension "sklearn.metrics.pairwise_fast" sources
    building extension "sklearn.neighbors.ball_tree" sources
    building extension "sklearn.neighbors.kd_tree" sources
    building extension "sklearn.neighbors.dist_metrics" sources
    building extension "sklearn.neighbors.typedefs" sources
    building extension "sklearn.neighbors.quad_tree" sources
    building extension "sklearn.tree._tree" sources
    building extension "sklearn.tree._splitter" sources
    building extension "sklearn.tree._criterion" sources
    building extension "sklearn.tree._utils" sources
    building extension "sklearn.utils.sparsefuncs_fast" sources
    building extension "sklearn.utils._cython_blas" sources
    building extension "sklearn.utils.arrayfuncs" sources
    building extension "sklearn.utils.murmurhash" sources
    building extension "sklearn.utils.graph_shortest_path" sources
    building extension "sklearn.utils.fast_dict" sources
    building extension "sklearn.utils.seq_dataset" sources
    building extension "sklearn.utils.weight_vector" sources
    building extension "sklearn.utils._random" sources
    building extension "sklearn.utils._logistic_sigmoid" sources
    building extension "sklearn.svm.libsvm" sources
    building extension "sklearn.svm.liblinear" sources
    building extension "sklearn.svm.libsvm_sparse" sources
    building extension "sklearn.linear_model.cd_fast" sources
    building extension "sklearn.linear_model.sgd_fast" sources
    building extension "sklearn.linear_model.sag_fast" sources
    building extension "sklearn._isotonic" sources
    building data_files sources
    build_src: building npy-pkg config files
    writing scikit_learn.egg-info/PKG-INFO
    writing dependency_links to scikit_learn.egg-info/dependency_links.txt
    writing requirements to scikit_learn.egg-info/requires.txt
    writing top-level names to scikit_learn.egg-info/top_level.txt
    reading manifest file 'scikit_learn.egg-info/SOURCES.txt'
    reading manifest template 'MANIFEST.in'
    adding license file 'COPYING'
    writing manifest file 'scikit_learn.egg-info/SOURCES.txt'
    running build_ext
    customize UnixCCompiler
    customize UnixCCompiler using build_clib
    customize UnixCCompiler
    customize UnixCCompiler using build_ext_subclass
    customize UnixCCompiler
    customize UnixCCompiler using build_ext_subclass
    Creating /opt/miniconda3/envs/testbed/lib/python3.6/site-packages/scikit-learn.egg-link (link to .)
    Adding scikit-learn 0.22.dev0 to easy-install.pth file

    Installed /testbed
    Partial import of sklearn during the build process.
Successfully installed scikit-learn-0.22.dev0
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv
+ git apply -v -
<stdin>:19: trailing whitespace.
    
<stdin>:22: trailing whitespace.
    
<stdin>:27: trailing whitespace.
    
Checking patch sklearn/tests/test_coverup_scikit-learn__scikit-learn-14894.py...
Applied patch sklearn/tests/test_coverup_scikit-learn__scikit-learn-14894.py cleanly.
warning: 3 lines add whitespace errors.
+ python3 /root/trace.py --timing --trace --count -C coverage.cover --include-pattern '/testbed/(sklearn/svm/base\.py)' -m pytest --no-header -rA -p no:cacheprovider sklearn/tests/test_coverup_scikit-learn__scikit-learn-14894.py
['--timing', '--trace', '--count', '-C', 'coverage.cover', '--include-pattern', '/testbed/(sklearn/svm/base\\.py)']
============================= test session starts ==============================
collected 1 item

sklearn/tests/test_coverup_scikit-learn__scikit-learn-14894.py F         [100%]

=================================== FAILURES ===================================
____________________ test_zero_division_error_in_sparse_fit ____________________

    def test_zero_division_error_in_sparse_fit():
        # Create a sparse matrix input that leads to an empty support_vectors_
        x_train = np.array([[0, 1, 0, 0],
                            [0, 0, 0, 1],
                            [0, 0, 1, 0],
                            [0, 0, 0, 1]])
        y_train = np.array([0.04, 0.04, 0.10, 0.16])
    
        # Convert to sparse matrix
        x_train_sparse = scipy.sparse.csr_matrix(x_train)
    
        # Initialize the SVR model
        model = SVR(C=316.227766017, cache_size=200, coef0=0.0, degree=3, epsilon=0.1,
                    gamma=1.0, kernel='linear', max_iter=15000,
                    shrinking=True, tol=0.001, verbose=False)
    
        # Fit the model and expect no error
        try:
>           model.fit(x_train_sparse, y_train)

sklearn/tests/test_coverup_scikit-learn__scikit-learn-14894.py:24: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = SVR(C=316.227766017, cache_size=200, coef0=0.0, degree=3, epsilon=0.1,
    gamma=1.0, kernel='linear', max_iter=15000, shrinking=True, tol=0.001,
    verbose=False)
X = <4x4 sparse matrix of type '<class 'numpy.float64'>'
	with 4 stored elements in Compressed Sparse Row format>
y = array([0.04, 0.04, 0.1 , 0.16]), sample_weight = array([], dtype=float64)

    def fit(self, X, y, sample_weight=None):
        """Fit the SVM model according to the given training data.
    
        Parameters
        ----------
        X : {array-like, sparse matrix}, shape (n_samples, n_features)
            Training vectors, where n_samples is the number of samples
            and n_features is the number of features.
            For kernel="precomputed", the expected shape of X is
            (n_samples, n_samples).
    
        y : array-like, shape (n_samples,)
            Target values (class labels in classification, real numbers in
            regression)
    
        sample_weight : array-like, shape (n_samples,)
            Per-sample weights. Rescale C per sample. Higher weights
            force the classifier to put more emphasis on these points.
    
        Returns
        -------
        self : object
    
        Notes
        -----
        If X and y are not C-ordered and contiguous arrays of np.float64 and
        X is not a scipy.sparse.csr_matrix, X and/or y may be copied.
    
        If X is a dense array, then the other methods will not support sparse
        matrices as input.
        """
    
        rnd = check_random_state(self.random_state)
    
        sparse = sp.isspmatrix(X)
        if sparse and self.kernel == "precomputed":
            raise TypeError("Sparse precomputed kernels are not supported.")
        self._sparse = sparse and not callable(self.kernel)
    
        X, y = check_X_y(X, y, dtype=np.float64,
                         order='C', accept_sparse='csr',
                         accept_large_sparse=False)
        y = self._validate_targets(y)
    
        sample_weight = np.asarray([]
                                   if sample_weight is None
                                   else sample_weight, dtype=np.float64)
        solver_type = LIBSVM_IMPL.index(self._impl)
    
        # input validation
        if solver_type != 2 and X.shape[0] != y.shape[0]:
            raise ValueError("X and y have incompatible shapes.\n" +
                             "X has %s samples, but y has %s." %
                             (X.shape[0], y.shape[0]))
    
        if self.kernel == "precomputed" and X.shape[0] != X.shape[1]:
            raise ValueError("Precomputed matrix must be a square matrix."
                             " Input is a {}x{} matrix."
                             .format(X.shape[0], X.shape[1]))
    
        if sample_weight.shape[0] > 0 and sample_weight.shape[0] != X.shape[0]:
            raise ValueError("sample_weight and X have incompatible shapes: "
                             "%r vs %r\n"
                             "Note: Sparse matrices cannot be indexed w/"
                             "boolean masks (use `indices=True` in CV)."
                             % (sample_weight.shape, X.shape))
    
        if isinstance(self.gamma, str):
            if self.gamma == 'scale':
                # var = E[X^2] - E[X]^2 if sparse
                X_var = ((X.multiply(X)).mean() - (X.mean()) ** 2
                         if sparse else X.var())
                self._gamma = 1.0 / (X.shape[1] * X_var) if X_var != 0 else 1.0
            elif self.gamma == 'auto':
                self._gamma = 1.0 / X.shape[1]
            else:
                raise ValueError(
                    "When 'gamma' is a string, it should be either 'scale' or "
                    "'auto'. Got '{}' instead.".format(self.gamma)
                )
        else:
            self._gamma = self.gamma
    
        kernel = self.kernel
        if callable(kernel):
            kernel = 'precomputed'
    
        fit = self._sparse_fit if self._sparse else self._dense_fit
        if self.verbose:  # pragma: no cover
            print('[LibSVM]', end='')
    
        seed = rnd.randint(np.iinfo('i').max)
>       fit(X, y, sample_weight, solver_type, kernel, random_seed=seed)

sklearn/svm/base.py:198: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = SVR(C=316.227766017, cache_size=200, coef0=0.0, degree=3, epsilon=0.1,
    gamma=1.0, kernel='linear', max_iter=15000, shrinking=True, tol=0.001,
    verbose=False)
X = <4x4 sparse matrix of type '<class 'numpy.float64'>'
	with 4 stored elements in Compressed Sparse Row format>
y = array([0.04, 0.04, 0.1 , 0.16]), sample_weight = array([], dtype=float64)
solver_type = 3, kernel = 'linear', random_seed = 1685193492

    def _sparse_fit(self, X, y, sample_weight, solver_type, kernel,
                    random_seed):
        X.data = np.asarray(X.data, dtype=np.float64, order='C')
        X.sort_indices()
    
        kernel_type = self._sparse_kernels.index(kernel)
    
        libsvm_sparse.set_verbosity_wrap(self.verbose)
    
        self.support_, self.support_vectors_, dual_coef_data, \
            self.intercept_, self._n_support, \
            self.probA_, self.probB_, self.fit_status_ = \
            libsvm_sparse.libsvm_sparse_train(
                X.shape[1], X.data, X.indices, X.indptr, y, solver_type,
                kernel_type, self.degree, self._gamma, self.coef0, self.tol,
                self.C, self.class_weight_,
                sample_weight, self.nu, self.cache_size, self.epsilon,
                int(self.shrinking), int(self.probability), self.max_iter,
                random_seed)
    
        self._warn_from_fit_status()
    
        if hasattr(self, "classes_"):
            n_class = len(self.classes_) - 1
        else:  # regression
            n_class = 1
        n_SV = self.support_vectors_.shape[0]
    
        dual_coef_indices = np.tile(np.arange(n_SV), n_class)
        dual_coef_indptr = np.arange(0, dual_coef_indices.size + 1,
>                                    dual_coef_indices.size / n_class)
E       ZeroDivisionError: float division by zero

sklearn/svm/base.py:291: ZeroDivisionError

During handling of the above exception, another exception occurred:

    def test_zero_division_error_in_sparse_fit():
        # Create a sparse matrix input that leads to an empty support_vectors_
        x_train = np.array([[0, 1, 0, 0],
                            [0, 0, 0, 1],
                            [0, 0, 1, 0],
                            [0, 0, 0, 1]])
        y_train = np.array([0.04, 0.04, 0.10, 0.16])
    
        # Convert to sparse matrix
        x_train_sparse = scipy.sparse.csr_matrix(x_train)
    
        # Initialize the SVR model
        model = SVR(C=316.227766017, cache_size=200, coef0=0.0, degree=3, epsilon=0.1,
                    gamma=1.0, kernel='linear', max_iter=15000,
                    shrinking=True, tol=0.001, verbose=False)
    
        # Fit the model and expect no error
        try:
            model.fit(x_train_sparse, y_train)
        except ZeroDivisionError:
>           pytest.fail("ZeroDivisionError was raised during sparse fit")
E           Failed: ZeroDivisionError was raised during sparse fit

sklearn/tests/test_coverup_scikit-learn__scikit-learn-14894.py:26: Failed
----------------------------- Captured stdout call -----------------------------
0.87 /testbed/sklearn/svm/base.py(76):         if self._impl not in LIBSVM_IMPL:  # pragma: no cover
0.87 /testbed/sklearn/svm/base.py(80):         if gamma == 0:
0.87 /testbed/sklearn/svm/base.py(85):         self.kernel = kernel
0.87 /testbed/sklearn/svm/base.py(86):         self.degree = degree
0.87 /testbed/sklearn/svm/base.py(87):         self.gamma = gamma
0.87 /testbed/sklearn/svm/base.py(88):         self.coef0 = coef0
0.87 /testbed/sklearn/svm/base.py(89):         self.tol = tol
0.87 /testbed/sklearn/svm/base.py(90):         self.C = C
0.87 /testbed/sklearn/svm/base.py(91):         self.nu = nu
0.87 /testbed/sklearn/svm/base.py(92):         self.epsilon = epsilon
0.87 /testbed/sklearn/svm/base.py(93):         self.shrinking = shrinking
0.87 /testbed/sklearn/svm/base.py(94):         self.probability = probability
0.87 /testbed/sklearn/svm/base.py(95):         self.cache_size = cache_size
0.87 /testbed/sklearn/svm/base.py(96):         self.class_weight = class_weight
0.87 /testbed/sklearn/svm/base.py(97):         self.verbose = verbose
0.87 /testbed/sklearn/svm/base.py(98):         self.max_iter = max_iter
0.87 /testbed/sklearn/svm/base.py(99):         self.random_state = random_state
0.87 /testbed/sklearn/svm/base.py(138):         rnd = check_random_state(self.random_state)
0.87 /testbed/sklearn/svm/base.py(140):         sparse = sp.isspmatrix(X)
0.87 /testbed/sklearn/svm/base.py(141):         if sparse and self.kernel == "precomputed":
0.87 /testbed/sklearn/svm/base.py(143):         self._sparse = sparse and not callable(self.kernel)
0.87 /testbed/sklearn/svm/base.py(145):         X, y = check_X_y(X, y, dtype=np.float64,
0.87 /testbed/sklearn/svm/base.py(146):                          order='C', accept_sparse='csr',
0.87 /testbed/sklearn/svm/base.py(147):                          accept_large_sparse=False)
0.87 /testbed/sklearn/svm/base.py(148):         y = self._validate_targets(y)
0.87 /testbed/sklearn/svm/base.py(221):         self.class_weight_ = np.empty(0)
0.87 /testbed/sklearn/svm/base.py(222):         return column_or_1d(y, warn=True).astype(np.float64, copy=False)
0.87 /testbed/sklearn/svm/base.py(150):         sample_weight = np.asarray([]
0.87 /testbed/sklearn/svm/base.py(151):                                    if sample_weight is None
0.87 /testbed/sklearn/svm/base.py(153):         solver_type = LIBSVM_IMPL.index(self._impl)
0.87 /testbed/sklearn/svm/base.py(156):         if solver_type != 2 and X.shape[0] != y.shape[0]:
0.87 /testbed/sklearn/svm/base.py(161):         if self.kernel == "precomputed" and X.shape[0] != X.shape[1]:
0.87 /testbed/sklearn/svm/base.py(166):         if sample_weight.shape[0] > 0 and sample_weight.shape[0] != X.shape[0]:
0.87 /testbed/sklearn/svm/base.py(173):         if isinstance(self.gamma, str):
0.87 /testbed/sklearn/svm/base.py(187):             self._gamma = self.gamma
0.87 /testbed/sklearn/svm/base.py(189):         kernel = self.kernel
0.87 /testbed/sklearn/svm/base.py(190):         if callable(kernel):
0.87 /testbed/sklearn/svm/base.py(193):         fit = self._sparse_fit if self._sparse else self._dense_fit
0.87 /testbed/sklearn/svm/base.py(194):         if self.verbose:  # pragma: no cover
0.87 /testbed/sklearn/svm/base.py(197):         seed = rnd.randint(np.iinfo('i').max)
0.87 /testbed/sklearn/svm/base.py(198):         fit(X, y, sample_weight, solver_type, kernel, random_seed=seed)
0.87 /testbed/sklearn/svm/base.py(263):         X.data = np.asarray(X.data, dtype=np.float64, order='C')
0.87 /testbed/sklearn/svm/base.py(264):         X.sort_indices()
0.88 /testbed/sklearn/svm/base.py(266):         kernel_type = self._sparse_kernels.index(kernel)
0.88 /testbed/sklearn/svm/base.py(268):         libsvm_sparse.set_verbosity_wrap(self.verbose)
0.88 /testbed/sklearn/svm/base.py(273):             libsvm_sparse.libsvm_sparse_train(
0.88 /testbed/sklearn/svm/base.py(274):                 X.shape[1], X.data, X.indices, X.indptr, y, solver_type,
0.88 /testbed/sklearn/svm/base.py(275):                 kernel_type, self.degree, self._gamma, self.coef0, self.tol,
0.88 /testbed/sklearn/svm/base.py(276):                 self.C, self.class_weight_,
0.88 /testbed/sklearn/svm/base.py(277):                 sample_weight, self.nu, self.cache_size, self.epsilon,
0.88 /testbed/sklearn/svm/base.py(278):                 int(self.shrinking), int(self.probability), self.max_iter,
0.88 /testbed/sklearn/svm/base.py(279):                 random_seed)
0.88 /testbed/sklearn/svm/base.py(281):         self._warn_from_fit_status()
0.88 /testbed/sklearn/svm/base.py(225):         assert self.fit_status_ in (0, 1)
0.88 /testbed/sklearn/svm/base.py(226):         if self.fit_status_ == 1:
0.88 /testbed/sklearn/svm/base.py(283):         if hasattr(self, "classes_"):
0.88 /testbed/sklearn/svm/base.py(286):             n_class = 1
0.88 /testbed/sklearn/svm/base.py(287):         n_SV = self.support_vectors_.shape[0]
0.88 /testbed/sklearn/svm/base.py(289):         dual_coef_indices = np.tile(np.arange(n_SV), n_class)
0.88 /testbed/sklearn/svm/base.py(290):         dual_coef_indptr = np.arange(0, dual_coef_indices.size + 1,
0.88 /testbed/sklearn/svm/base.py(291):                                      dual_coef_indices.size / n_class)
=========================== short test summary info ============================
FAILED sklearn/tests/test_coverup_scikit-learn__scikit-learn-14894.py::test_zero_division_error_in_sparse_fit
============================== 1 failed in 0.28s ===============================
+ cat coverage.cover
{"/testbed/sklearn/svm/base.py": {"1": 1, "2": 1, "3": 1, "4": 1, "6": 1, "7": 1, "8": 1, "9": 1, "10": 1, "11": 1, "12": 1, "13": 1, "14": 1, "15": 1, "16": 1, "17": 1, "18": 1, "19": 1, "22": 1, "25": 1, "58": 2, "503": 2, "732": 1, "796": 1, "34": 0, "38": 0, "39": 0, "40": 0, "42": 0, "43": 0, "45": 0, "48": 0, "50": 0, "53": 0, "54": 0, "55": 0, "69": 1, "71": 1, "101": 1, "106": 1, "214": 1, "224": 1, "232": 1, "261": 1, "296": 1, "315": 1, "337": 1, "360": 1, "371": 1, "401": 1, "417": 1, "439": 1, "466": 1, "484": 1, "487": 1, "76": 1, "77": 0, "78": 0, "80": 1, "81": 0, "83": 0, "85": 1, "86": 1, "87": 1, "88": 1, "89": 1, "90": 1, "91": 1, "92": 1, "93": 1, "94": 1, "95": 1, "96": 1, "97": 1, "98": 1, "99": 1, "104": 0, "138": 1, "140": 1, "141": 1, "142": 0, "143": 1, "145": 1, "146": 1, "147": 1, "148": 1, "150": 1, "151": 1, "152": 0, "153": 1, "156": 1, "157": 0, "158": 0, "159": 0, "161": 1, "162": 0, "164": 0, "166": 1, "167": 0, "171": 0, "173": 1, "174": 0, "177": 0, "178": 0, "179": 0, "180": 0, "182": 0, "183": 0, "184": 0, "187": 1, "189": 1, "190": 1, "191": 0, "193": 1, "194": 1, "195": 0, "197": 1, "198": 1, "201": 0, "206": 0, "207": 0, "208": 0, "209": 0, "210": 0, "212": 0, "221": 1, "222": 1, "225": 1, "226": 1, "227": 0, "230": 0, "234": 0, "237": 0, "238": 0, "240": 0, "241": 0, "243": 0, "249": 0, "250": 0, "251": 0, "252": 0, "253": 0, "254": 0, "255": 0, "256": 0, "257": 0, "259": 0, "263": 1, "264": 1, "266": 1, "268": 1, "273": 1, "274": 1, "275": 1, "276": 1, "277": 1, "278": 1, "279": 1, "281": 1, "283": 1, "284": 0, "286": 1, "287": 1, "289": 1, "290": 1, "291": 1, "292": 0, "293": 0, "294": 0, "311": 0, "312": 0, "313": 0, "316": 0, "317": 0, "318": 0, "320": 0, "321": 0, "322": 0, "323": 0, "324": 0, "326": 0, "328": 0, "330": 0, "331": 0, "332": 0, "333": 0, "334": 0, "335": 0, "339": 0, "340": 0, "341": 0, "343": 0, "345": 0, "347": 0, "348": 0, "349": 0, "350": 0, "351": 0, "352": 0, "353": 0, "354": 0, "355": 0, "356": 0, "357": 0, "358": 0, "362": 0, "365": 0, "366": 0, "367": 0, "368": 0, "369": 0, "386": 0, "387": 0, "389": 0, "390": 0, "392": 0, "396": 0, "397": 0, "399": 0, "402": 0, "403": 0, "405": 0, "406": 0, "407": 0, "409": 0, "410": 0, "411": 0, "412": 0, "413": 0, "414": 0, "415": 0, "418": 0, "420": 0, "421": 0, "422": 0, "424": 0, "426": 0, "427": 0, "428": 0, "429": 0, "430": 0, "431": 0, "432": 0, "433": 0, "434": 0, "435": 0, "436": 0, "437": 0, "440": 0, "442": 0, "443": 0, "444": 0, "445": 0, "446": 0, "447": 0, "449": 0, "450": 0, "451": 0, "452": 0, "453": 0, "455": 0, "456": 0, "457": 0, "459": 0, "460": 0, "461": 0, "463": 0, "464": 0, "468": 0, "469": 0, "472": 0, "476": 0, "478": 0, "481": 0, "482": 0, "485": 0, "489": 0, "490": 0, "491": 0, "492": 0, "494": 0, "495": 0, "496": 0, "500": 0, "505": 1, "519": 1, "533": 1, "564": 1, "597": 1, "605": 1, "635": 1, "644": 1, "674": 1, "677": 1, "694": 1, "716": 1, "510": 0, "511": 0, "512": 0, "513": 0, "514": 0, "515": 0, "516": 0, "517": 0, "520": 0, "521": 0, "522": 0, "523": 0, "524": 0, "525": 0, "526": 0, "527": 0, "529": 0, "531": 0, "559": 0, "560": 0, "561": 0, "562": 0, "580": 0, "581": 0, "582": 0, "585": 0, "586": 0, "587": 0, "588": 0, "590": 0, "591": 0, "598": 0, "599": 0, "601": 0, "602": 0, "632": 0, "633": 0, "636": 0, "637": 0, "638": 0, "641": 0, "642": 0, "671": 0, "672": 0, "675": 0, "678": 0, "680": 0, "681": 0, "682": 0, "684": 0, "685": 0, "686": 0, "687": 0, "688": 0, "689": 0, "690": 0, "692": 0, "695": 0, "697": 0, "698": 0, "699": 0, "701": 0, "703": 0, "704": 0, "705": 0, "706": 0, "707": 0, "708": 0, "709": 0, "710": 0, "711": 0, "712": 0, "713": 0, "714": 0, "717": 0, "719": 0, "722": 0, "723": 0, "724": 0, "725": 0, "727": 0, "729": 0, "750": 0, "751": 0, "753": 0, "755": 0, "756": 0, "758": 0, "760": 0, "761": 0, "764": 0, "765": 0, "766": 0, "767": 0, "768": 0, "770": 0, "771": 0, "772": 0, "774": 0, "775": 0, "776": 0, "778": 0, "780": 0, "781": 0, "782": 0, "784": 0, "786": 0, "787": 0, "789": 0, "888": 0, "889": 0, "890": 0, "891": 0, "892": 0, "893": 0, "895": 0, "897": 0, "899": 0, "900": 0, "901": 0, "902": 0, "903": 0, "904": 0, "907": 0, "908": 0, "909": 0, "910": 0, "912": 0, "914": 0, "916": 0, "917": 0, "918": 0, "921": 0, "922": 0, "925": 0, "926": 0, "928": 0, "929": 0, "931": 0, "932": 0, "933": 0, "934": 0, "935": 0, "940": 0, "941": 0, "942": 0, "943": 0, "945": 0, "946": 0, "947": 0, "949": 0, "950": 0, "952": 0}}
+ git checkout fdbaa58acbead5a254f2e6d597dc1ab3b947f4c6
Note: switching to 'fdbaa58acbead5a254f2e6d597dc1ab3b947f4c6'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by switching back to a branch.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -c with the switch command. Example:

  git switch -c <new-branch-name>

Or undo this operation with:

  git switch -

Turn off this advice by setting config variable advice.detachedHead to false

HEAD is now at fdbaa58acb TST Skip some doctests if pillow not installed (#15131)
+ git apply /root/pre_state.patch
error: unrecognized input
